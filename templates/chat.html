<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RAG Chat · Hep-Cavity</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <aside id="sidebar">
    <h2>History</h2>
    <ul id="history-list"></ul>
    <h2>
  <a href="/logout" style="float:right;font-size:0.8em">Log out</a>
</h2>

  </aside>

  <main>
    <div id="chat-window"></div>

    <form id="prompt-form">
      <textarea id="prompt" rows="2" placeholder="Ask me anything…"></textarea>
      <button>Send</button> 
      <input
  type="file"
  id="pdf-upload"
  name="pdf"
  accept="application/pdf"
  style="margin-left:8px; align-self:center;"
  onchange="handleFileUpload(this)"
  >
    </form>
  </main>

<script>
const chatWin   = document.getElementById("chat-window");
const promptInp = document.getElementById("prompt");
const histUl    = document.getElementById("history-list");

// --- helpers ---------------------------------------------------
function addMsg(role, html, autoScroll = true)  {
   const msg = document.createElement("div");
   msg.className = "msg " + role;
   msg.innerHTML = html;
   chatWin.appendChild(msg);
   if (autoScroll) {
    chatWin.scrollTop = chatWin.scrollHeight; }
    
    return msg 
   }
function handleFileUpload(input) {
  if (!input.files.length) return;
  const formData = new FormData();
  formData.append('pdf', input.files[0]);
  fetch('/upload', { method: 'POST', body: formData })
    .then(res => res.text())
    .then(msg => { alert(msg); input.value = null; })
    .catch(() => alert('Upload failed'));
}
function loadHistory() {
  fetch("/history")
    .then(r => r.json())
    .then(arr => {
      histUl.innerHTML = "";

      arr.forEach((m, i) => {
        if (m.role !== "user") return;

        const li = document.createElement("li");
        li.textContent = m.html.replace(/<[^>]+>/g, "").slice(0, 40);

        li.onclick = () => {
        chatWin.innerHTML = "";
 
        const elems = [];               // keep references to every turn element
        arr.forEach((mm, j) => {
          elems.push(addMsg(mm.role, mm.html,false));
        });

        const target = elems[i];        // i == index of the clicked user turn

        // Wait one paint-cycle so the browser knows the elements’ positions,
        // then scroll the chat container to the target’s offset.
        requestAnimationFrame(() => {
          chatWin.scrollTo({
            top:  target.offsetTop - 8,  // small margin
            behavior: "smooth"
          });
        });
      };


        histUl.appendChild(li);
      });
    });
}
loadHistory();
// --- submit prompt --------------------------------------------
document.getElementById("prompt-form").addEventListener("submit",ev=>{
  ev.preventDefault();
  const q = promptInp.value.trim();
  if(!q) return;
  promptInp.value="";
  addMsg("user", q.replace(/</g,"&lt;"));
  fetch("/chat",{
     method:"POST",
     headers:{"Content-Type":"application/json"},
     body:JSON.stringify({message:q})
  })
  .then(r=>r.json())
  .then(res=>{
     addMsg("assistant", res.answer_html);
     (res.media||[]).forEach(([kind,url])=>{
        if(kind==="img"){
            addMsg("assistant", `<img src="${url}" class="inline-img">`);
        }else{
            addMsg("assistant",
              `<iframe src="${url}" class="tbl-frame"></iframe>`);
        }
     });
     loadHistory();
  });
});
</script>
</body>
</html>
